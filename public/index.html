<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gesti√≥n de Facturas - Nofre Plomer</title>
    <link rel="stylesheet" href="style.css?v=2.0">
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">

</head>

<body>
    <div class="container">
        <header>
            <div>
                <h1>üìã Gesti√≥n de Facturas</h1>
                <p>Sistema completo de facturaci√≥n con art√≠culos y servicios</p>
            </div>
            <div class="user-info" id="userInfo" style="display: none;">
                <span id="userName"></span>
                <button onclick="logout()" class="btn-logout">Cerrar Sesi√≥n</button>
            </div>
        </header>

        <nav class="tabs">
            <button class="tab-btn active" data-tab="invoices">Facturas</button>
            <button class="tab-btn" data-tab="articles">Art√≠culos/Servicios</button>
            <button class="tab-btn" data-tab="clients">Clientes</button>
            <button class="tab-btn" data-tab="companies">Empresas</button>
            <button class="tab-btn" data-tab="users" id="usersTab" style="display: none;">Usuarios</button>
            <button class="tab-btn" data-tab="backups" id="backupsTab" style="display: none;">üì¶ Backups</button>
        </nav>

        <main>
            <!-- INVOICES TAB -->
            <div id="invoices-tab" class="tab-content active">
                <section class="card form-section">
                    <h2>Nueva Factura</h2>
                    <form id="invoiceForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="invoice_company">Empresa Emisora *</label>
                                <select id="invoice_company" required>
                                    <option value="">Seleccionar empresa...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="invoice_number">N¬∫ Factura *</label>
                                <input type="text" id="invoice_number" required placeholder="F-2024-001">
                            </div>
                            <div class="form-group">
                                <label for="date">Fecha *</label>
                                <input type="date" id="date" required>
                            </div>
                            <div class="form-group">
                                <label for="client_type">Tipo de Cliente *</label>
                                <select id="client_type" required>
                                    <option value="empresa">Empresa</option>
                                    <option value="particular">Particular</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="client_selector">Seleccionar Cliente Guardado</label>
                                <select id="client_selector">
                                    <option value="">-- Manual / No guardado --</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="client_name">Cliente / Nombre *</label>
                                <input type="text" id="client_name" required placeholder="Nombre del cliente">
                            </div>
                            <div class="form-group">
                                <label for="client_cif">NIF/CIF *</label>
                                <input type="text" id="client_cif" required placeholder="12345678A">
                            </div>
                            <div class="form-group full-width">
                                <label for="client_address">Direcci√≥n/Obra</label>
                                <input type="text" id="client_address"
                                    placeholder="Direcci√≥n del cliente o ubicaci√≥n de la obra">
                            </div>
                            <div class="form-group full-width">
                                <label for="notes">Notas</label>
                                <input type="text" id="notes" placeholder="Observaciones adicionales">
                            </div>
                        </div>

                        <!-- INVOICE ITEMS TABLE (Excel-like) -->
                        <div class="invoice-items-section">
                            <div class="section-header">
                                <h3>L√≠neas de Factura</h3>
                                <button type="button" class="btn-add-line" id="addLineBtn">+ A√±adir L√≠nea</button>
                            </div>

                            <div class="table-container excel-table">
                                <table id="invoiceItemsTable">
                                    <thead>
                                        <tr>
                                            <th style="width: 25%;">Art√≠culo/Servicio</th>
                                            <th style="width: 30%;">Descripci√≥n</th>
                                            <th style="width: 10%;">Cantidad</th>
                                            <th style="width: 12%;">Precio Unit.</th>
                                            <th style="width: 8%;">IVA %</th>
                                            <th style="width: 12%;">Total</th>
                                            <th style="width: 3%;"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="invoiceItemsBody">
                                        <!-- Lines will be added dynamically -->
                                    </tbody>
                                </table>
                            </div>

                            <!-- TOTALS -->
                            <div class="totals-panel">
                                <div class="total-row">
                                    <span class="total-label">Subtotal:</span>
                                    <span class="total-value" id="subtotalDisplay">0,00 ‚Ç¨</span>
                                </div>
                                <div class="total-row">
                                    <span class="total-label">IVA Total:</span>
                                    <span class="total-value" id="vatTotalDisplay">0,00 ‚Ç¨</span>
                                </div>
                                <div class="total-row total-final">
                                    <span class="total-label">TOTAL:</span>
                                    <span class="total-value" id="totalDisplay">0,00 ‚Ç¨</span>
                                </div>
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="button" class="btn-secondary" id="saveDraftBtn">üíæ Guardar Borrador</button>
                            <button type="submit" class="btn-primary" id="finalizeInvoiceBtn">üìù Finalizar y
                                Bloquear</button>
                            <button type="button" class="btn-secondary" id="clearFormBtn">üóëÔ∏è Limpiar</button>
                            <button type="button" class="btn-danger hidden" id="cancelEditBtn">‚ùå Cancelar
                                Edici√≥n</button>
                        </div>
                    </form>
                </section>

                <section class="card list-section">
                    <div class="section-header">
                        <h2>Historial de Facturas</h2>
                        <div class="header-actions">
                            <button class="btn-secondary" id="exportCsvBtn">üìÑ Exportar CSV</button>
                            <button class="btn-secondary" id="printListBtn">üñ®Ô∏è Imprimir Listado</button>
                        </div>
                    </div>
                    <!-- Advanced Filters Panel -->
                    <div class="filters-panel">
                        <div class="filter-row">
                            <div class="filter-group">
                                <label>Empresa:</label>
                                <select id="filter_company">
                                    <option value="">Todas</option>
                                </select>
                            </div>

                            <div class="filter-group">
                                <label>Desde:</label>
                                <input type="date" id="filter_date_from">
                            </div>

                            <div class="filter-group">
                                <label>Hasta:</label>
                                <input type="date" id="filter_date_to">
                            </div>

                            <div class="filter-group">
                                <label>Cliente:</label>
                                <input type="text" id="filter_client" placeholder="Buscar cliente...">
                            </div>
                        </div>

                        <div class="filter-row">
                            <div class="filter-group">
                                <label>N¬∫ Factura:</label>
                                <input type="text" id="filter_invoice_number" placeholder="Buscar n¬∫...">
                            </div>

                            <div class="filter-group">
                                <label>Tipo:</label>
                                <select id="filter_client_type">
                                    <option value="">Todos</option>
                                    <option value="empresa">Empresa</option>
                                    <option value="particular">Particular</option>
                                </select>
                            </div>

                            <div class="filter-group">
                                <label>Veri*Factu:</label>
                                <select id="filter_verifactu">
                                    <option value="">Todos</option>
                                    <option value="yes">Con Veri*Factu</option>
                                    <option value="no">Sin Veri*Factu</option>
                                </select>
                            </div>

                            <div class="filter-group">
                                <label>Estado:</label>
                                <select id="filter_status">
                                    <option value="">Todos</option>
                                    <option value="active">Activas</option>
                                    <option value="cancelled">Anuladas</option>
                                </select>
                            </div>

                            <div class="filter-group">
                                <button class="btn-secondary" id="clearFilters">üîÑ Limpiar</button>
                            </div>
                        </div>
                    </div>
                    <div class="table-container">
                        <table id="invoicesTable">
                            <thead>
                                <tr>
                                    <th>Empresa</th>
                                    <th>N¬∫ Factura</th>
                                    <th>Fecha</th>
                                    <th>Cliente</th>
                                    <th>Estado</th>
                                    <th>Tipo</th>
                                    <th>Total</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Generated by JS -->
                            </tbody>
                        </table>
                    </div>
                </section>
            </div>

            <!-- ARTICLES TAB -->
            <div id="articles-tab" class="tab-content">
                <section class="card">
                    <div class="section-header">
                        <h2>Gesti√≥n de Art√≠culos y Servicios</h2>
                        <button type="button" class="btn-primary" id="toggleArticleForm">+ Nuevo Art√≠culo</button>
                    </div>

                    <div id="articleFormContainer" class="hidden">
                        <form id="articleForm">
                            <input type="hidden" id="article_id_edit">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="article_code">C√≥digo</label>
                                    <input type="text" id="article_code" placeholder="ART-001">
                                </div>
                                <div class="form-group">
                                    <label for="article_name">Nombre *</label>
                                    <input type="text" id="article_name" required placeholder="Nombre del art√≠culo">
                                </div>
                                <div class="form-group full-width">
                                    <label for="article_description">Descripci√≥n</label>
                                    <input type="text" id="article_description" placeholder="Descripci√≥n detallada">
                                </div>
                                <div class="form-group">
                                    <label for="article_price">Precio Unitario (‚Ç¨) *</label>
                                    <input type="number" id="article_price" step="0.01" required placeholder="0.00">
                                </div>
                                <div class="form-group">
                                    <label for="article_vat">IVA (%) *</label>
                                    <select id="article_vat">
                                        <option value="21">21%</option>
                                        <option value="10">10%</option>
                                        <option value="4">4%</option>
                                        <option value="0">0%</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="article_category">Categor√≠a</label>
                                    <input type="text" id="article_category" placeholder="Ej: Fontaner√≠a, Electricidad">
                                </div>
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn-primary">Guardar Art√≠culo</button>
                                <button type="button" class="btn-secondary" id="cancelArticleForm">Cancelar</button>
                            </div>
                        </form>
                    </div>

                    <div class="search-box">
                        <input type="text" id="articleSearch" placeholder="üîç Buscar art√≠culos...">
                    </div>

                    <div class="table-container">
                        <table id="articlesTable">
                            <thead>
                                <tr>
                                    <th>C√≥digo</th>
                                    <th>Nombre</th>
                                    <th>Descripci√≥n</th>
                                    <th>Precio</th>
                                    <th>IVA</th>
                                    <th>Categor√≠a</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Generated by JS -->
                            </tbody>
                        </table>
                    </div>
                </section>
            </div>

            <!-- CLIENTS TAB -->
            <div id="clients-tab" class="tab-content">
                <section class="card form-section">
                    <div class="section-header">
                        <h2>Gesti√≥n de Clientes</h2>
                        <button type="button" class="btn-primary" id="toggleClientForm">+ Nuevo Cliente</button>
                    </div>

                    <div id="clientFormContainer" class="hidden">
                        <form id="clientForm">
                            <input type="hidden" id="client_id_edit">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="client_name_mgt">Nombre / Raz√≥n Social *</label>
                                    <input type="text" id="client_name_mgt" required placeholder="Nombre del cliente">
                                </div>
                                <div class="form-group">
                                    <label for="client_cif_mgt">NIF/CIF *</label>
                                    <input type="text" id="client_cif_mgt" required placeholder="12345678A">
                                </div>
                                <div class="form-group">
                                    <label for="client_type_mgt">Tipo de Cliente *</label>
                                    <select id="client_type_mgt" required>
                                        <option value="empresa">Empresa</option>
                                        <option value="particular">Particular</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="client_phone_mgt">Tel√©fono</label>
                                    <input type="tel" id="client_phone_mgt" placeholder="971 123 456">
                                </div>
                                <div class="form-group">
                                    <label for="client_email_mgt">Email</label>
                                    <input type="email" id="client_email_mgt" placeholder="cliente@ejemplo.com">
                                </div>
                                <div class="form-group full-width">
                                    <label for="client_address_mgt">Direcci√≥n</label>
                                    <input type="text" id="client_address_mgt" placeholder="Calle Ejemplo, 123">
                                </div>
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn-secondary" id="cancelClientForm">Cancelar</button>
                                <button type="submit" class="btn-primary">Guardar Cliente</button>
                            </div>
                        </form>
                    </div>
                </section>

                <section class="card table-secondary">
                    <table id="clientsTable">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>CIF/NIF</th>
                                <th>Contacto</th>
                                <th>Tipo</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Se cargar√° din√°micamente -->
                        </tbody>
                    </table>
                </section>
            </div>

            <!-- COMPANIES TAB -->
            <div id="companies-tab" class="tab-content">
                <section class="card">
                    <h2>Gesti√≥n de Empresas</h2>
                    <div class="company-controls">
                        <div class="company-selector">
                            <label for="active_company">Empresa Activa:</label>
                            <select id="active_company">
                                <option value="">Seleccionar empresa...</option>
                            </select>
                        </div>
                        <button type="button" class="btn-secondary" id="toggleCompanyForm">+ Nueva Empresa</button>
                    </div>

                    <div id="companyFormContainer" class="hidden">
                        <form id="companyForm">
                            <input type="hidden" id="company_id_edit">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="company_name">Nombre de Empresa *</label>
                                    <input type="text" id="company_name" required placeholder="Mi Empresa S.L.">
                                </div>
                                <div class="form-group">
                                    <label for="company_cif">CIF *</label>
                                    <input type="text" id="company_cif" required placeholder="B12345678">
                                </div>
                                <div class="form-group">
                                    <label for="company_address">Direcci√≥n</label>
                                    <input type="text" id="company_address" placeholder="Calle Principal, 123">
                                </div>
                                <div class="form-group">
                                    <label for="company_phone">Tel√©fono</label>
                                    <input type="tel" id="company_phone" placeholder="971 123 456">
                                </div>
                                <div class="form-group">
                                    <label for="company_email">Email</label>
                                    <input type="email" id="company_email" placeholder="info@empresa.com">
                                </div>
                                <div class="form-group">
                                    <label for="company_bank_iban">IBAN Bancario</label>
                                    <input type="text" id="company_bank_iban"
                                        placeholder="ES00 0000 0000 0000 0000 0000">
                                </div>

                                <div class="form-group">
                                    <label for="company_logo">Logo de la Empresa</label>
                                    <input type="file" id="company_logo" accept="image/*">
                                    <div id="logo_preview" class="logo-preview" style="display:none;">
                                        <img id="logo_preview_img" src="" alt="Preview"
                                            style="max-width: 200px; margin-top: 10px;">
                                        <br>
                                        <button type="button" id="remove_logo_btn" class="btn-secondary"
                                            style="margin-top: 10px;">Eliminar Logo</button>
                                    </div>
                                </div>
                            </div>
                            <!-- companyFormContainer/form continue here -->

                            <div class="verifactu-section">
                                <h3>‚ö° Configuraci√≥n Veri*Factu</h3>
                                <p class="info-text">Sistema de integridad y trazabilidad seg√∫n RD 1007/2023</p>

                                <div class="form-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="verifactu_enabled">
                                        <span>Habilitar Veri*Factu (facturas con hash y c√≥digo QR)</span>
                                    </label>
                                </div>

                                <div id="verifactu_details" class="hidden">
                                    <div class="form-group">
                                        <label for="verifactu_software_id">ID Software (opcional)</label>
                                        <input type="text" id="verifactu_software_id" placeholder="SYS-FACT-001">
                                    </div>
                                    <div class="form-group">
                                        <label for="verifactu_certificate_file">Certificado Digital (.p12) *</label>
                                        <input type="file" id="verifactu_certificate_file" accept=".p12">
                                        <small id="certificate_status"
                                            style="display:block; margin-top:5px; color:#666;"></small>
                                    </div>
                                    <div class="form-group">
                                        <label for="verifactu_certificate_password">Contrase√±a del Certificado *</label>
                                        <input type="password" id="verifactu_certificate_password"
                                            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                                    </div>
                                    <div class="alert-warning">
                                        <strong>‚ö†Ô∏è Importante:</strong> Una vez habilitado Veri*Factu, las facturas no
                                        podr√°n
                                        ser eliminadas, solo anuladas. Esto garantiza la integridad de la cadena de
                                        bloques.
                                    </div>
                                </div>
                            </div>

                            <div class="form-actions">
                                <button type="submit" class="btn-primary">Guardar Empresa</button>
                                <button type="button" class="btn-secondary" id="cancelCompanyForm">Cancelar</button>
                            </div>
                        </form>
                    </div> <!-- companyFormContainer -->

                    <div class="table-container" style="margin-top: 20px;">
                        <table id="companiesTable">
                            <thead>
                                <tr>
                                    <th>Empresa</th>
                                    <th>CIF</th>
                                    <th>Contacto</th>
                                    <th>Veri*Factu</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Generated by JS -->
                            </tbody>
                        </table>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- PDF Preview Modal -->
    <div id="pdfModal" class="modal hidden">
        <div class="modal-content pdf-modal-content">
            <div class="modal-header">
                <h3 id="pdfModalTitle">Vista Previa - Factura</h3>
                <button class="modal-close" id="closePdfModal">&times;</button>
            </div>
            <div class="modal-body pdf-modal-body">
                <iframe id="pdfViewer" class="pdf-viewer"></iframe>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" id="closePdfModalBtn">Cerrar</button>
                <button class="btn-primary" id="downloadFromModal">üìÑ Descargar</button>
            </div>
        </div>
    </div>

    <!-- USERS TAB (Admin only) -->
    <div id="users-tab" class="tab-content">
        <section class="card form-section">
            <div class="section-header">
                <h2>Gesti√≥n de Usuarios</h2>
                <button class="btn-primary" id="toggleUserForm">+ Nuevo Usuario</button>
            </div>

            <div id="userFormContainer" class="hidden">
                <form id="userForm">
                    <input type="hidden" id="user_id_edit">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="user_username">Usuario *</label>
                            <input type="text" id="user_username" required>
                        </div>
                        <div class="form-group">
                            <label for="user_password">Contrase√±a *</label>
                            <input type="password" id="user_password" required minlength="6">
                        </div>
                        <div class="form-group">
                            <label for="user_full_name">Nombre Completo *</label>
                            <input type="text" id="user_full_name" required>
                        </div>
                        <div class="form-group">
                            <label for="user_email">Email</label>
                            <input type="email" id="user_email">
                        </div>
                        <div class="form-group">
                            <label for="user_role">Rol *</label>
                            <select id="user_role" required>
                                <option value="user">Usuario</option>
                                <option value="admin">Administrador</option>
                                <option value="viewer">Visor</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn-primary">Guardar Usuario</button>
                        <button type="button" class="btn-secondary" id="cancelUserForm">Cancelar</button>
                    </div>
                </form>
            </div>
        </section>

        <section class="card">
            <h2>Usuarios del Sistema</h2>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Usuario</th>
                            <th>Nombre</th>
                            <th>Email</th>
                            <th>Rol</th>
                            <th>Estado</th>
                            <th>√öltimo Acceso</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <!-- Generated by JS -->
                    </tbody>
                </table>
            </div>
        </section>
    </div>

    <!-- BACKUPS TAB (Admin only) -->
    <div id="backups-tab" class="tab-content">
        <div class="content-header">
            <h2>üì¶ Copias de Seguridad</h2>
            <button id="createBackupBtn" class="btn-primary">+ Crear Backup</button>
        </div>

        <section class="card">
            <h3>‚ö†Ô∏è Restaurar Backup</h3>
            <p style="color: #666; margin-bottom: 15px;">
                <strong>Advertencia:</strong> Restaurar un backup sobrescribir√° todos los datos actuales.
                Se crear√° un backup de seguridad autom√°ticamente antes de restaurar.
            </p>
            <div style="display: flex; gap: 10px; align-items: center;">
                <input type="file" id="backupFileInput" accept=".zip" style="flex: 1;">
                <button id="restoreBackupBtn" class="btn-warning">Restaurar Backup</button>
            </div>
        </section>

        <section class="card">
            <h3>Backups Disponibles</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Fecha de Creaci√≥n</th>
                            <th>Tama√±o</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="backupsTableBody">
                        <!-- Generated by JS -->
                    </tbody>
                </table>
            </div>
        </section>
    </div>

    <!-- Article Selector Modal -->
    <div id="articleModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Seleccionar Art√≠culo/Servicio</h3>
                <button class="modal-close" id="closeArticleModal">&times;</button>
            </div>
            <div class="modal-body">
                <input type="text" id="modalArticleSearch" placeholder="üîç Buscar art√≠culo..." class="search-input">
                <div id="articlesList" class="articles-list">
                    <!-- Generated by JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Confirmation Modal -->
    <div id="confirmModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="confirmModalTitle">‚ö†Ô∏è Confirmar acci√≥n</h3>
            </div>
            <div class="modal-body">
                <p id="confirmModalMessage"></p>
            </div>
            <div class="modal-footer">
                <button type="button" id="confirmModalCancel" class="btn-secondary">Cancelar</button>
                <button type="button" id="confirmModalConfirm" class="btn-danger">Confirmar</button>
            </div>
        </div>
    </div>

    <script src="confirm-modal.js?v=1.2"></script>
    <script src="app.js?v=1.2"></script>
    <script src="logo-management.js?v=1.2"></script>
    <script src="backup-management.js?v=1.2"></script>
</body>

</html>